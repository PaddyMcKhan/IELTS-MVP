{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/lordp/IELTS-MVP/src/app/api/score/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport OpenAI from \"openai\";\n\nconst client = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY!,\n});\n\n// Choose model depending on free vs pro mode\nfunction pickModel(isPro: boolean) {\n  // ENV override (owner-level)\n  if (process.env.AI_PRO_MODE === \"true\") return \"gpt-4o\";\n\n  // URL-level override\n  if (isPro) return \"gpt-4o\";\n\n  // Default (free tier)\n  return \"gpt-4o-mini\";\n}\n\nexport async function POST(req: Request) {\n  try {\n    const { essay, task, wordCount, question } = await req.json();\n\n    // Detect if this user is requesting pro mode\n    const { searchParams } = new URL(req.url);\n    const isPro = searchParams.get(\"pro\") === \"true\";\n\n    const model = pickModel(isPro);\n\n    const minWords = task === \"task1\" ? 150 : 250;\n\n    const prompt = `\nYou are an official IELTS Writing Examiner.\n\nEvaluate the following Task ${task === \"task1\" ? \"1\" : \"2\"} essay using the \nIELTS Academic Writing band descriptors.\n\nYou MUST return ONLY valid JSON in this exact shape, with no markdown and no comments:\n\n{\n  \"taskResponse\": number,\n  \"coherence\": number,\n  \"lexical\": number,\n  \"grammar\": number,\n  \"overall\": number,\n  \"comments\": {\n    \"overview\": string,\n    \"taskResponse\": string,\n    \"coherence\": string,\n    \"lexical\": string,\n    \"grammar\": string,\n    \"advice\": string\n  }\n}\n\nRound all band scores to the nearest 0.5.\n\n# Essay Question:\n${question}\n\n# Candidate Essay:\n${essay}\n\n# Word Count: ${wordCount}\n# Min Required: ${minWords}\n    `.trim();\n\n    const completion = await client.responses.create({\n      model,\n      input: prompt,\n      max_output_tokens: 1024,\n    });\n\n    // Get raw text and strip any accidental ```json fences\n    let raw = completion.output_text.trim();\n\n    if (raw.startsWith(\"```\")) {\n      const firstNewline = raw.indexOf(\"\\n\");\n      const lastFence = raw.lastIndexOf(\"```\");\n      if (firstNewline !== -1) {\n        raw = raw.slice(firstNewline + 1, lastFence === -1 ? undefined : lastFence).trim();\n      }\n    }\n\n    const json = JSON.parse(raw);\n\n    return NextResponse.json({\n      ...json,\n      modelUsed: model,\n    });\n  } catch (err: any) {\n    console.error(\"Scoring error:\", err);\n    return NextResponse.json(\n      {\n        error: \"Failed to score essay\",\n        detail: err?.message,\n        type: err?.type ?? \"unknown\",\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AAAA;;;AAEA,MAAM,SAAS,IAAI,mLAAM,CAAC;IACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;AACpC;AAEA,6CAA6C;AAC7C,SAAS,UAAU,KAAc;IAC/B,6BAA6B;IAC7B,IAAI,QAAQ,GAAG,CAAC,WAAW,KAAK,QAAQ,OAAO;IAE/C,qBAAqB;IACrB,IAAI,OAAO,OAAO;IAElB,sBAAsB;IACtB,OAAO;AACT;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,SAAS,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QAE3D,6CAA6C;QAC7C,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;QACxC,MAAM,QAAQ,aAAa,GAAG,CAAC,WAAW;QAE1C,MAAM,QAAQ,UAAU;QAExB,MAAM,WAAW,SAAS,UAAU,MAAM;QAE1C,MAAM,SAAS,CAAC;;;4BAGQ,EAAE,SAAS,UAAU,MAAM,IAAI;;;;;;;;;;;;;;;;;;;;;;;;AAwB3D,EAAE,SAAS;;;AAGX,EAAE,MAAM;;cAEM,EAAE,UAAU;gBACV,EAAE,SAAS;IACvB,CAAC,CAAC,IAAI;QAEN,MAAM,aAAa,MAAM,OAAO,SAAS,CAAC,MAAM,CAAC;YAC/C;YACA,OAAO;YACP,mBAAmB;QACrB;QAEA,uDAAuD;QACvD,IAAI,MAAM,WAAW,WAAW,CAAC,IAAI;QAErC,IAAI,IAAI,UAAU,CAAC,QAAQ;YACzB,MAAM,eAAe,IAAI,OAAO,CAAC;YACjC,MAAM,YAAY,IAAI,WAAW,CAAC;YAClC,IAAI,iBAAiB,CAAC,GAAG;gBACvB,MAAM,IAAI,KAAK,CAAC,eAAe,GAAG,cAAc,CAAC,IAAI,YAAY,WAAW,IAAI;YAClF;QACF;QAEA,MAAM,OAAO,KAAK,KAAK,CAAC;QAExB,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,GAAG,IAAI;YACP,WAAW;QACb;IACF,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,kBAAkB;QAChC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,QAAQ,KAAK;YACb,MAAM,KAAK,QAAQ;QACrB,GACA;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}