{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/lordp/IELTS-MVP/src/app/api/attempts/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\n// Supabase setup\nconst supabaseUrl =\n  process.env.NEXT_PUBLIC_SUPABASE_URL ??\n  process.env.SUPABASE_URL ??\n  \"\";\n\nconst supabaseKey =\n  process.env.SUPABASE_SERVICE_ROLE_KEY ??\n  process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY ??\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ??\n  process.env.SUPABASE_ANON_KEY ??\n  \"\";\n\nif (!supabaseUrl || !supabaseKey) {\n  console.error(\"[/api/attempts] Missing Supabase env variables\");\n}\n\nconst supabase = createClient(supabaseUrl, supabaseKey);\n\n// POST /api/attempts\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json();\n\n    const {\n      questionId,\n      questionText,\n      module,\n      task,\n      essay,        // legacy text, if used\n      essayText,    // main essay content\n      wordCount,\n      isPro,\n      userId,       // should come from client when logged in\n      scoreJson,    // full scoring JSON from AI examiner\n      coherence,\n      lexical,\n      grammar,\n      taskResponse,\n      overallBand,  // optional, may or may not be passed\n    } = body;\n\n    // Try to extract overall band from scoreJson if not explicitly given\n    let derivedOverall: number | null = null;\n    if (typeof overallBand === \"number\") {\n      derivedOverall = overallBand;\n    } else if (\n      scoreJson &&\n      typeof scoreJson === \"object\" &&\n      typeof scoreJson.overall === \"number\"\n    ) {\n      derivedOverall = scoreJson.overall;\n    }\n\n    const payload: any = {\n      // numeric scores (nullable is fine)\n      coherence: typeof coherence === \"number\" ? coherence : null,\n      lexical: typeof lexical === \"number\" ? lexical : null,\n      grammar: typeof grammar === \"number\" ? grammar : null,\n      overall_band: derivedOverall,\n      task_response:\n        typeof taskResponse === \"number\" ? taskResponse : null,\n\n      // metadata\n      is_pro: !!isPro,\n      module: module ?? null,\n      task: task ?? null,\n      question_id: questionId ?? null,\n      question_text: questionText ?? null,\n      user_id: userId ?? null,\n      word_count:\n        typeof wordCount === \"number\" ? wordCount : null,\n\n      // essay content\n      essay: essay ?? null,\n      essay_text: essayText ?? essay ?? null,\n\n      // âœ… IMPORTANT: store as real JSON object, not string\n      score_json: scoreJson ?? null,\n    };\n\n    const { error } = await supabase\n      .from(\"essay_attempts\")\n      .insert(payload);\n\n    if (error) {\n      console.error(\"Supabase save error:\", error);\n      return NextResponse.json(\n        { ok: false, error: error.message ?? \"Supabase error\" },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({ ok: true });\n  } catch (err) {\n    console.error(\"Unexpected error in POST /api/attempts:\", err);\n    return NextResponse.json(\n      { ok: false, error: \"Unexpected error\" },\n      { status: 500 }\n    );\n  }\n}\n\n// GET /api/attempts?userId=...\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const userId = searchParams.get(\"userId\");\n\n    let query = supabase\n      .from(\"essay_attempts\")\n      .select(\"*\")\n      .order(\"created_at\", { ascending: false });\n\n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) {\n      console.error(\"Error loading attempts:\", error);\n      return NextResponse.json(\n        { error: \"Failed to load attempts\" },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({ attempts: data ?? [] });\n  } catch (err) {\n    console.error(\"Unexpected error in GET /api/attempts:\", err);\n    return NextResponse.json(\n      { error: \"Unexpected error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}