{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/lordp/IELTS-MVP/src/app/api/attempts/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\n// Match the Supabase Next.js quickstart env naming.\nconst supabaseUrl =\n  process.env.NEXT_PUBLIC_SUPABASE_URL ??\n  process.env.SUPABASE_URL ??\n  \"\";\n\nconst supabaseKey =\n  process.env.SUPABASE_SERVICE_ROLE_KEY ??\n  process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY ??\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ??\n  process.env.SUPABASE_ANON_KEY ??\n  \"\";\n\nconst supabase =\n  supabaseUrl && supabaseKey\n    ? createClient(supabaseUrl, supabaseKey)\n    : null;\n\n// ✅ POST: save a single attempt\nexport async function POST(req: Request) {\n  try {\n    if (!supabase) {\n      console.error(\"Supabase client is not configured\");\n      return NextResponse.json(\n        { error: \"Supabase client is not configured\" },\n        { status: 500 }\n      );\n    }\n\n    const { questionId, essayText, score, userId } = await req.json();\n\n    if (!questionId || !essayText) {\n      return NextResponse.json(\n        { error: \"Missing required fields\" },\n        { status: 400 }\n      );\n    }\n\n    const { error } = await supabase.from(\"essay_attempts\").insert({\n      user_id: userId ?? null,       // currently this will be null until we trust a real userId\n      question_id: questionId,\n      essay_text: essayText,\n      score_json: score,\n    });\n\n    if (error) {\n      console.error(\"Supabase save error:\", error);\n      return NextResponse.json(\n        { error: \"Failed to save essay attempt\" },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({ success: true });\n  } catch (err) {\n    console.error(\"Unexpected error in POST /api/attempts:\", err);\n    return NextResponse.json(\n      { error: \"Unexpected error\" },\n      { status: 500 }\n    );\n  }\n}\n\n// ✅ GET: fetch recent attempts (optionally filtered by userId)\nexport async function GET(req: Request) {\n  try {\n    if (!supabase) {\n      console.error(\"Supabase client is not configured\");\n      return NextResponse.json(\n        { error: \"Supabase client is not configured\" },\n        { status: 500 }\n      );\n    }\n\n    const { searchParams } = new URL(req.url);\n    const userId = searchParams.get(\"userId\");\n\n    let query = supabase\n      .from(\"essay_attempts\")\n      .select(\"*\")\n      .order(\"created_at\", { ascending: false })\n      .limit(20);\n\n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) {\n      console.error(\"Supabase fetch error:\", error);\n      return NextResponse.json(\n        { error: \"Failed to load attempts\" },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({ attempts: data ?? [] });\n  } catch (err) {\n    console.error(\"Unexpected error in GET /api/attempts:\", err);\n    return NextResponse.json(\n      { error: \"Unexpected error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,oDAAoD;AACpD,MAAM,cACJ,gFACA,QAAQ,GAAG,CAAC,YAAY,IACxB;AAEF,MAAM,cACJ,QAAQ,GAAG,CAAC,yBAAyB,IACrC,QAAQ,GAAG,CAAC,oCAAoC,4PAEhD,QAAQ,GAAG,CAAC,iBAAiB,IAC7B;AAEF,MAAM,WACJ,eAAe,cACX,IAAA,yMAAY,EAAC,aAAa,eAC1B;AAGC,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,IAAI,CAAC,UAAU;YACb,QAAQ,KAAK,CAAC;YACd,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAoC,GAC7C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,EAAE,UAAU,EAAE,SAAS,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,IAAI;QAE/D,IAAI,CAAC,cAAc,CAAC,WAAW;YAC7B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,kBAAkB,MAAM,CAAC;YAC7D,SAAS,UAAU;YACnB,aAAa;YACb,YAAY;YACZ,YAAY;QACd;QAEA,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,wBAAwB;YACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA+B,GACxC;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,2CAA2C;QACzD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAmB,GAC5B;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,IAAI,GAAY;IACpC,IAAI;QACF,IAAI,CAAC,UAAU;YACb,QAAQ,KAAK,CAAC;YACd,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAoC,GAC7C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;QACxC,MAAM,SAAS,aAAa,GAAG,CAAC;QAEhC,IAAI,QAAQ,SACT,IAAI,CAAC,kBACL,MAAM,CAAC,KACP,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAET,IAAI,QAAQ;YACV,QAAQ,MAAM,EAAE,CAAC,WAAW;QAC9B;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM;QAE9B,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,yBAAyB;YACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,UAAU,QAAQ,EAAE;QAAC;IAClD,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,0CAA0C;QACxD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAmB,GAC5B;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}