{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/lordp/IELTS-MVP/src/utils/supabase/server.ts"],"sourcesContent":["// src/utils/supabase/server.ts\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\n\nexport function createClient() {\n  const url =\n    process.env.SUPABASE_URL ?? process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key =\n    process.env.SUPABASE_SERVICE_ROLE_KEY ??\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  if (!url || !key) {\n    throw new Error(\n      \"Missing Supabase environment variables. Check SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_URL / NEXT_PUBLIC_SUPABASE_ANON_KEY.\"\n    );\n  }\n\n  return createSupabaseClient(url, key);\n}\n"],"names":[],"mappings":"AAAA,+BAA+B;;;;;AAC/B;;AAEO,SAAS;IACd,MAAM,MACJ,QAAQ,GAAG,CAAC,YAAY;IAC1B,MAAM,MACJ,QAAQ,GAAG,CAAC,yBAAyB;IAGvC,IAAI,CAAC,OAAO,CAAC,KAAK;QAChB,MAAM,IAAI,MACR;IAEJ;IAEA,OAAO,IAAA,yMAAoB,EAAC,KAAK;AACnC","debugId":null}},
    {"offset": {"line": 65, "column": 0}, "map": {"version":3,"sources":["file:///Users/lordp/IELTS-MVP/src/app/api/score/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport OpenAI from \"openai\";\nimport { createClient } from \"@/utils/supabase/server\";\n\nconst client = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY!,\n});\n\n// Choose model depending on free vs pro mode\nfunction pickModel(isPro: boolean) {\n  // ENV override (owner-level)\n  if (process.env.AI_PRO_MODE === \"true\") return \"gpt-4o\";\n\n  // URL-level override\n  if (isPro) return \"gpt-4o\";\n\n  // Default (free tier)\n  return \"gpt-4o-mini\";\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n\n    const {\n      essay,\n      task,                // \"task1\" | \"task2\" from UI\n      wordCount,\n      question,            // client copy of prompt (fallback only)\n      questionId,          // writing_tasks.id\n      taskType,            // e.g. \"task2_academic\" (fallback only)\n      minWords: clientMinWords, // min words from client (fallback only)\n    } = body ?? {};\n\n    // Basic validation\n    if (!essay || !task || typeof wordCount !== \"number\") {\n      return NextResponse.json(\n        { error: \"Missing required fields for scoring.\" },\n        { status: 400 }\n      );\n    }\n\n    // Detect if this user is requesting pro mode (?pro=true)\n    const { searchParams } = new URL(req.url);\n    const isPro = searchParams.get(\"pro\") === \"true\";\n\n    const model = pickModel(isPro);\n\n    // ðŸ”‘ Step 11E: fetch canonical task data from Supabase\n    const supabase = createClient();\n\n    let dbTask: any = null;\n\n    if (questionId) {\n      const { data, error } = await supabase\n        .from(\"writing_tasks\")\n        .select(\"id, prompt, min_words, task_type\")\n        .eq(\"id\", questionId)\n        .single();\n\n      if (!error && data) {\n        dbTask = data;\n      } else {\n        console.warn(\"Score API: failed to load writing_tasks row\", {\n          questionId,\n          error,\n        });\n      }\n    }\n\n    // Canonical values (DB â†’ client â†’ defaults)\n    const canonicalPrompt: string =\n      dbTask?.prompt ??\n      question ??\n      \"Unknown IELTS Writing task prompt (no prompt supplied).\";\n\n    const canonicalTaskType: string =\n      dbTask?.task_type ??\n      taskType ??\n      (task === \"task1\" ? \"task1_academic\" : \"task2_academic\");\n\n    const canonicalMinWords: number =\n      typeof dbTask?.min_words === \"number\"\n        ? dbTask.min_words\n        : typeof clientMinWords === \"number\"\n        ? clientMinWords\n        : task === \"task1\"\n        ? 150\n        : 250;\n\n    const taskNumber = task === \"task1\" ? \"1\" : \"2\";\n    const moduleLabel = canonicalTaskType.endsWith(\"_general\")\n      ? \"General Training\"\n      : \"Academic\";\n\n    const prompt = `\nYou are an official IELTS Writing Examiner.\n\nEvaluate the following Writing Task ${taskNumber} (${moduleLabel}) essay\nusing the official IELTS Writing band descriptors for Task ${taskNumber}.\n\nTask metadata:\n- taskId: ${questionId ?? \"unknown\"}\n- taskType: ${canonicalTaskType}\n- module: ${moduleLabel}\n- minWords: ${canonicalMinWords}\n\nYou MUST return ONLY valid JSON in this exact shape, with no markdown and no comments:\n\n{\n  \"taskResponse\": number,\n  \"coherence\": number,\n  \"lexical\": number,\n  \"grammar\": number,\n  \"overall\": number,\n  \"comments\": {\n    \"overview\": string,\n    \"taskResponse\": string,\n    \"coherence\": string,\n    \"lexical\": string,\n    \"grammar\": string,\n    \"advice\": string\n  }\n}\n\nRound all band scores to the nearest 0.5.\n\n# Essay Question:\n${canonicalPrompt}\n\n# Candidate Essay:\n${essay}\n\n# Word Count: ${wordCount}\n# Min Required: ${canonicalMinWords}\n    `.trim();\n\n    const completion = await client.responses.create({\n      model,\n      input: prompt,\n      max_output_tokens: 1024,\n    });\n\n    // Get raw text and strip any accidental ```json fences\n    let raw = completion.output_text.trim();\n\n    if (raw.startsWith(\"```\")) {\n      const firstNewline = raw.indexOf(\"\\n\");\n      const lastFence = raw.lastIndexOf(\"```\");\n      if (firstNewline !== -1) {\n        raw = raw\n          .slice(firstNewline + 1, lastFence === -1 ? undefined : lastFence)\n          .trim();\n      }\n    }\n\n    const json = JSON.parse(raw);\n\n    return NextResponse.json({\n      ...json,\n      modelUsed: model,\n    });\n  } catch (err: any) {\n    console.error(\"Scoring error:\", err);\n    return NextResponse.json(\n      {\n        error: \"Failed to score essay\",\n        detail: err?.message,\n        type: err?.type ?? \"unknown\",\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}