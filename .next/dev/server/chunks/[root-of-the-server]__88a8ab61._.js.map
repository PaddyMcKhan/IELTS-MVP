{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///Users/lordp/IELTS-MVP/src/app/api/attempts/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { getServerSession } from \"next-auth\";\n\n// Match your Supabase env setup\nconst supabaseUrl =\n  process.env.NEXT_PUBLIC_SUPABASE_URL ??\n  process.env.SUPABASE_URL ??\n  \"\";\n\nconst supabaseKey =\n  process.env.SUPABASE_SERVICE_ROLE_KEY ??\n  process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY ??\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ??\n  process.env.SUPABASE_ANON_KEY ??\n  \"\";\n\nconst supabase =\n  supabaseUrl && supabaseKey\n    ? createClient(supabaseUrl, supabaseKey)\n    : null;\n\n// POST ‚Äî save an attempt with user_id resolved via NextAuth email\nexport async function POST(req: Request) {\n  try {\n    const { questionId, essayText, score } = await req.json();\n\n    if (!supabase) {\n      return NextResponse.json({ error: \"Supabase not configured\" }, { status: 500 });\n    }\n\n    // üîë Get session\n    const session = await getServerSession();\n\n    let userId: string | null = null;\n\n    // If logged in ‚Üí look up matching row in Supabase \"User\" table\n    if (session?.user?.email) {\n      const { data: userRow, error: userError } = await supabase\n        .from(\"User\")       // ‚Üê your existing Supabase table\n        .select(\"id\")\n        .eq(\"email\", session.user.email)\n        .maybeSingle();\n\n      if (userRow?.id) userId = userRow.id;\n    }\n\n    // Save into essay_attempts\n    const { error } = await supabase.from(\"essay_attempts\").insert({\n      user_id: userId,             // ‚Üê NOW FILLED CORRECTLY\n      question_id: questionId,\n      essay_text: essayText,\n      score_json: score,\n    });\n\n    if (error) {\n      console.error(\"Supabase save error:\", error);\n      return NextResponse.json({ error: \"Failed to save essay attempt\" }, { status: 500 });\n    }\n\n    return NextResponse.json({ success: true });\n  } catch (err) {\n    console.error(\"Unexpected error in POST /api/attempts:\", err);\n    return NextResponse.json({ error: \"Unexpected error\" }, { status: 500 });\n  }\n}\n\n// GET ‚Äî returns attempts for current user\nexport async function GET(req: Request) {\n  try {\n    if (!supabase) {\n      return NextResponse.json({ error: \"Supabase not configured\" }, { status: 500 });\n    }\n\n    const session = await getServerSession();\n\n    let userId: string | null = null;\n\n    if (session?.user?.email) {\n      const { data: userRow } = await supabase\n        .from(\"User\")\n        .select(\"id\")\n        .eq(\"email\", session.user.email)\n        .maybeSingle();\n\n      if (userRow?.id) userId = userRow.id;\n    }\n\n    if (!userId) {\n      return NextResponse.json({ attempts: [] }, { status: 200 });\n    }\n\n    const { data, error } = await supabase\n      .from(\"essay_attempts\")\n      .select(\"*\")\n      .eq(\"user_id\", userId)\n      .order(\"created_at\", { ascending: false })\n      .limit(20);\n\n    if (error) {\n      console.error(\"Supabase fetch error:\", error);\n      return NextResponse.json({ error: \"Failed to load attempts\" }, { status: 500 });\n    }\n\n    return NextResponse.json({ attempts: data ?? [] });\n  } catch (err) {\n    console.error(\"Unexpected error in GET /api/attempts:\", err);\n    return NextResponse.json({ error: \"Unexpected error\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}