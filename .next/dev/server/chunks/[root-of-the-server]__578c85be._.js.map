{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/lordp/IELTS-MVP/src/lib/prisma.ts"],"sourcesContent":["// src/lib/prisma.ts\nimport { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"error\", \"warn\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalForPrisma.prisma = prisma;\n}\n"],"names":[],"mappings":"AAAA,oBAAoB;;;;;AACpB;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B","debugId":null}},
    {"offset": {"line": 73, "column": 0}, "map": {"version":3,"sources":["file:///Users/lordp/IELTS-MVP/src/app/api/drafts/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\n\ntype EssayMode = \"academic\" | \"general\";\ntype EssayTask = \"task1\" | \"task2\";\n\ntype SaveDraftRequest = {\n  userId: string | null;\n  questionId: string;\n  mode: EssayMode;\n  task: EssayTask;\n  essay: string;\n};\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n    const { userId, questionId, mode, task, essay } = body;\n\n    if (!userId || typeof questionId === \"undefined\") {\n      return NextResponse.json(\n        { message: \"Missing userId or questionId\" },\n        { status: 400 }\n      );\n    }\n\n    const qid = parseInt(String(questionId), 10);\n    if (Number.isNaN(qid)) {\n      return NextResponse.json(\n        { message: \"Invalid questionId\" },\n        { status: 400 }\n      );\n    }\n\n    const rows = await prisma.$queryRaw<{ id: string; updated_at: Date }[]>`\n      insert into essay_drafts (user_id, question_id, mode, task, essay_text)\n      values (${userId}::uuid, ${qid}::int, ${mode}, ${task}, ${essay})\n      on conflict (user_id, question_id) do update\n      set essay_text = excluded.essay_text,\n          mode = excluded.mode,\n          task = excluded.task,\n          updated_at = now()\n      returning id, updated_at;\n    `;\n\n    const [row] = rows;\n\n    return NextResponse.json({\n      id: row.id,\n      updatedAt: row.updated_at.toISOString(),\n    });\n  } catch (error: any) {\n    console.error(\"Unexpected error in POST /api/drafts:\", error);\n    return NextResponse.json(\n      { message: \"Unexpected error\", details: String(error?.message ?? error) },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function GET(req: Request) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const userId = searchParams.get(\"userId\");\n    const questionIdRaw = searchParams.get(\"questionId\");\n\n    if (!userId || !questionIdRaw) {\n      return NextResponse.json(\n        { message: \"Missing userId or questionId\" },\n        { status: 400 }\n      );\n    }\n\n    const questionId = parseInt(questionIdRaw, 10);\n    if (Number.isNaN(questionId)) {\n      return NextResponse.json(\n        { message: \"Invalid questionId\" },\n        { status: 400 }\n      );\n    }\n\n    const rows = await prisma.$queryRaw<\n      {\n        id: string;\n        question_id: number;\n        essay_text: string;\n        updated_at: Date;\n      }[]\n    >`\n      select id, question_id, essay_text, updated_at\n      from essay_drafts\n      where user_id = ${userId}::uuid\n        and question_id = ${questionId}::int\n      order by updated_at desc\n      limit 1;\n    `;\n\n    if (!rows.length) {\n      return NextResponse.json({ draft: null });\n    }\n\n    const [row] = rows;\n\n    return NextResponse.json({\n      draft: {\n        id: row.id,\n        questionId: row.question_id,\n        essay: row.essay_text,\n        updatedAt: row.updated_at.toISOString(),\n      },\n    });\n  } catch (error: any) {\n    console.error(\"Unexpected error in GET /api/drafts:\", error);\n    return NextResponse.json(\n      { message: \"Unexpected error\", details: String(error?.message ?? error) },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAaO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG;QAElD,IAAI,CAAC,UAAU,OAAO,eAAe,aAAa;YAChD,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;YAA+B,GAC1C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,MAAM,SAAS,OAAO,aAAa;QACzC,IAAI,OAAO,KAAK,CAAC,MAAM;YACrB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;YAAqB,GAChC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,gIAAM,CAAC,SAAS,AAAoC,CAAC;;cAE9D,EAAE,OAAO,QAAQ,EAAE,IAAI,OAAO,EAAE,KAAK,EAAE,EAAE,KAAK,EAAE,EAAE,MAAM;;;;;;;IAOlE,CAAC;QAED,MAAM,CAAC,IAAI,GAAG;QAEd,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,IAAI,IAAI,EAAE;YACV,WAAW,IAAI,UAAU,CAAC,WAAW;QACvC;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yCAAyC;QACvD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAoB,SAAS,OAAO,OAAO,WAAW;QAAO,GACxE;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe,IAAI,GAAY;IACpC,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;QACxC,MAAM,SAAS,aAAa,GAAG,CAAC;QAChC,MAAM,gBAAgB,aAAa,GAAG,CAAC;QAEvC,IAAI,CAAC,UAAU,CAAC,eAAe;YAC7B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;YAA+B,GAC1C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,aAAa,SAAS,eAAe;QAC3C,IAAI,OAAO,KAAK,CAAC,aAAa;YAC5B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;YAAqB,GAChC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,gIAAM,CAAC,SAAS,AAOlC,CAAC;;;sBAGgB,EAAE,OAAO;0BACL,EAAE,WAAW;;;IAGnC,CAAC;QAED,IAAI,CAAC,KAAK,MAAM,EAAE;YAChB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAK;QACzC;QAEA,MAAM,CAAC,IAAI,GAAG;QAEd,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,OAAO;gBACL,IAAI,IAAI,EAAE;gBACV,YAAY,IAAI,WAAW;gBAC3B,OAAO,IAAI,UAAU;gBACrB,WAAW,IAAI,UAAU,CAAC,WAAW;YACvC;QACF;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,wCAAwC;QACtD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAoB,SAAS,OAAO,OAAO,WAAW;QAAO,GACxE;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}